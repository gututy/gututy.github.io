---
title: 引言
tags: 计算机体系结构 学习笔记
aside:
    toc: ture
sidebar:
    nav: computer_architecture
---

# 引言
## 计算机体系结构的研究内容
### 1.横向：什么是计算机
- 现代信息系统
    - PC、服务器、高性能计算机……
    - 防火墙、交换机、打印机……
- 数字化生活
    - 手机、数码相机、数字电视……
- 武器装备
    - 舰船、飞机、坦克、导弹控制系统……
### 2.纵向：一以贯之
- 为什么按一下键盘可以翻一页幻灯片？
- 应用程序（WPS）、操作系统（Windows/Linux）、以CPU为核心的硬件系统、晶体管是怎么协同工作的？
- 上述过程中涉及的重要量化指标（性能、功耗、成本）的关系？

**以龙芯CPU为例**

- 按一下键盘，键盘会产生一个信号送到桥片（南桥、北桥）
- 桥片通过HT(Hyper Transpor)总线向处理器发出一个外部中断信号
- 中断信号被采集到ESTA控制寄存器，处理器查看控制寄存器ECFG和CRMD决定是否屏蔽
- 如果没有屏蔽，再传到寄存器重命名模块并附在四条指令的第一条中送到ROB(Re-Order Buffer,重排序缓冲)模块 //由于该指令发生例外，不会被送到功能部件执行
- 当该指令成为ROB的第一条指令被提交时CPU处理例外，此时ROB向所有模块发出取消信号，取消该指令后面的所有指令，在ERA、PRMD等寄存器中保存例外现场，将CRMD的PLV和IE设为0(是的系统进入核心态并禁止中断)
- 向取指模块发出中断信号，取指模块根据中断类型到对应入口地址取指
- CPU发现有未屏蔽中断跳转到该中断对应的例外处理入口：EEntry+offset
- 操作系统保留现场(把通用寄存器保存到堆栈区)
- 操作系统执行中断分派代码，逐级处理中断控制器的应答和溯源，获得具体的中断原因
- 操作系统根据中断原因调用驱动程序，读取键盘数据
- 操作系统唤醒正在由于等待数据而阻塞的进程(WPS)
- WPS根据读到的键盘数据决定翻一页，调用显示驱动程序
- 驱动程序把要显示的内容送到显存，并通知GPU(Graphic Processing Unit)
- GPU通过访问显存空间刷新屏幕

**翻一页**

---
- 如果幻灯片翻页觉得卡顿？
    - 系统中有没有其他任务在运行
      - 任务会占用CPU、内存带宽、IO带宽等资源……
    - CPU太慢，需要升级？(不一定)
      - WPS翻页时CPU干的活不多
      - 可能是下一页包含很多图形需要GPU画出来，GPU忙不过来
      - 可能是要显示的内容数据量大，把数据从WPS的应用程序空间传给GPU用的显存，内存带宽不足
      - 独立显存的情况下数据如何从内存传输到显存需要专门的机制，比如直接内存访问(Direct Memory Access,简称DMA)
---
**上知天文，下知地理**

![通用计算机系统结构层次](./第一章图/计算机系统的结构层次.png)

- 指令就是应用的“算子”
  - 哪些硬件实现？哪些软件实现？
- 结构设计结合应用行为
  - Cache利用应用访存局部性
  - 转移猜测利用转移相关性和重复性
- ISA和微结构要考虑OS的需求
  - 页表和TLB
  - 多线程支持、虚拟机支持
- 结构设计要考虑晶体管属性
  - Cache容量影响主频
  - 多发射结构发射电路影响主频
### 3.计算机的基本组成
- 为什么计算机使用二进制？
  - 计算机由电子元器件组成，二进制最容易实现
- 冯诺依曼结构
  - **基本思想**

    - 数据和程序都在存储器中，CPU从内存中取指令和数据进行运算并把结果也放在内存中

  - **主要特点**

    - ***存储程序*** ***指令驱动执行***

  - 优点
    - 自动、快速执行
  - 缺点
    - 指令驱动的顺序执行
    - CPU和存储器分开而且越来越远
  - 结构
    - 运算器、控制器、存储器、输入、输出
## 衡量计算机的指标

**性能、价格、功耗**是三个主要指标

其他因素：安全、体积、可靠性、稳定性、寿命；民用、工业用、军用、宇航用

### 计算机的性能
性能最本质的定义：**完成一个任务所需的时间**(以指令为基本单位)

完成一个任务所需要的时间=完成该任务需要的的指令数$\times$完成每条指令需要的拍数$\times$每拍需要的时间
$$
CPUTime=\frac{Seconds}{Program}=\frac{Instructions}{Program} \times \frac{Cycles}{Instruction} \times \frac{Seconds}{Cycle}
$$

|             |Inst.Count  |CPI      |Clock Rate|
| :-------:   | :-------:  | :-----: | :-----:  |
|Program      |X           |         |          |
|Compiler     |X           |(X)      |          |
|ISA          |X           |X        |          |
|Organization |            |X        |X         |
|Technology   |            |         |X         |

*注：X表示有关联，左侧表头从上到下依次为程序、编译器、指令集系统、微结构、工艺和电路设计*

- 影响因素
  - 算法影响最大
    - 如冒泡排序复杂度为$O(N^2)$，快速排序复杂度为$O(NlogN)$
  - 编译器影响
    - 一般有几倍的差距
  - 指令系统
    - 复杂指令如三角函数、FFT、AES等是否硬件实现
  - 微结构：影响IPC(Instructions per cycle)
    - 通过乱序执行、多发射、存储层次等提高IPC
  - 主频
    - 受工艺和微结构(流水线)的影响
- 评价原则
  - 拿程序来测，而不是看个别技术指标(如主频)
    - 一系列的基准程序
  - 不同计算机侧重点不一样，需要不同测试程序
    - 个人PC：单任务关注响应时间
    - 计算中心：多任务关注吞吐率
  - 测试程序要有代表性，要足够大，而不是拿个别程序测
    - 基准测试程序套件选取典型应用，能全面综合评价计算机性能。但其属于概要测试，不一定能准确反应用户程序的执行性能
  - 多个程序时，做归一化和几何平均比较公平
  - 测试报告要足够详细，要公开，要可以检查
- 常见基准程序套件
  - SPEC CPU基准测试程序
  - TPC(事务处理测试程序)
  - EEMBC(嵌入式基准测试程序)
  - LMBench(比较不同的unix系统性能)
### 计算机的成本
- 性价比中的价格因素
- 成本和性价比关系比较复杂
  - 超级计算机：主要追求性能，不太需要关注成本
  - 嵌入式应用：为降低成本和功耗可以牺牲一部分性能
  - 介于两者之间，例如PC、工作站、服务器等：追求性价比最优设计
- 影响因素
  - R&D(科学研究与试验发展)的成本
  - 生产成本：比如芯片成本、封装、测试成本
  - 总量：加速学习过程，降低一次性成本
### 计算机的功耗
- 主要是芯片功耗，芯片功耗主要由晶体管工作产生
  - 动态功耗
    - 反转功耗
    - 短路功耗
  - 静态功耗(漏电功耗)
- 优化方法
  - 优化动态功耗/静态功耗
  - 优化层次
    - 结构级：多发射vs.单发射；关闭不用的模块
    - 逻辑级：串行进位vs.并行进位加法器
    - 电路级：动态vs.静态电路
    - 工艺级：使用高性能vs.低功耗晶体管
## 计算机体系结构的发展趋势
### 体系结构发展的双动力
-  半导体工艺技术和计算机体系结构技术互为动力
    -  半导体工艺水平提高为计算机系统的涉及提供了更多更快的晶体管来实现更多功能、更高性能的系统，如TLB、流水线、多发射
    -  计算机体系结构发展是半导体技术发展的直接动力
- 应用需求是计算机体系结构发展的持久动力
  - 早期计算机都是应用于科学工程计算，只有少数人能用
  - 1980年代IBM把计算机摆到桌面大大促进了计算机工业发展
  - 本世纪初网络计算的普及又一次促进了计算机工业的发展
- **主要动力：2010年前工艺技术，2010年后应用需求**
### 摩尔定律支撑计算机发展
   > 摩尔定律：晶体管数目每18-24个月翻一番；同样晶体管数量的芯片价格下降一倍

- 摩尔定律与结构进步
  - 第一代：电子管计算机 每秒几千/万次
    - 冯诺依曼结构
  - 第二代：晶体管计算机 每秒几十万次
    - 高级程序语言出现：FORTRAN、COBOL等
    - IBM7094、CDC1604等
  - 第三代：中小规模IC(集成电路)计算机 每秒几百万次
    - 操作系统逐步成熟、小型机出现
    - IBM360、PDP11、VAX11
  - 第四代：大规模IC计算机 每秒亿次以上
    - 微处理器出现：Intel、AMD
    - 形成Wintel体系
- 摩尔定律与系统结构
  - 第一阶段：晶体管不够用
    - 计算机由很多独立芯片构成
    - 计算机结构受限于晶体管数目不够
  - 第二阶段：存储器速度太慢
    - 集成度提高，微处理器蓬勃发展
    - 存储容量指数增加，但访存速度增加缓慢
    - Cache占多达80%的芯片面积
  - 第三阶段：晶体管越来越多而"难"用
    - 设计验证能力提高与晶体管增加形成剪刀差
    - 功耗问题突出、连线成为主要矛盾
    - 不得已向多核发展
  - CMOS工艺正在面临物理极限
### 计算机应用与体系结构
 >   高性能计算机：Performance per second
    个人计算机：Performance per dollar
    移动智能终端：Performance per watt
### 计算机体系结构发展中碰到的墙
- 1980’s：存储墙
  - CPU变快，内存只变大不变快
  - 80%的晶体管用于片内高速缓存等
- 2000’s：功耗墙
  - 放弃复杂高主频设计，多核设计成为主流
- 未来可能遇到的墙
  - 带宽墙：“茶壶里倒饺子”
  - 成本墙：太贵了做不起或者用不起
  - 应用墙：多数量核的CPU卖给谁？量大面广的应用要用多少核？
  - 通用CPU性能提高的摩尔定律到2010-2015即告终止
## 计算机体系结构设计的基本原则
 >   **平衡性、局部性、并行性、虚拟化**
- 平衡性：结构设计要统筹兼顾
  - 保证通用性，峰值浮点运算速度(MFLOPS)与峰值访存带宽(MB/s)为1:1左右
  - Amdahl定律：关注短板

$$
ExTime_{new}=ExTime_{old} \times \left[ \left( 1 - Fraction_{enhanced}\right) + \frac{Fraction_{enhanced}}{Speedup_{enhanced}}\right]
$$

$$
    Speedup_{overall} = \frac{ExTime_{old}}{ExTime_{new}} = \frac{1}{\left( 1 - Fraction_{enhanced} \right) + \frac{Fraction_{enhanced}}{Speedup_{enhanced}}}
$$
- 局部性：结构设计要重点突出
  - 局部性是事物的一个普遍存在的性质
  - 计算机中的局部性事件
    - 指令局部性：指令顺序执行，循环体中的指令
    - 访存局部性：时间局部性(一个数据被访问后很有可能多次被访问)和空间局部性(一个数据被访问后它邻近的数据有可能被访问)
    - 转移局部性：同一条转移指令经常往同一个方向跳转
    - Cache、TLB、预取、转移猜测
- 并行性：人多力量大，开发各个层次的并行性
  - 指令级并行
    - 时间并行性：指令流水线
    - 空间并行性：多发射/超标量，乱序执行
  - 数据级并行：单指令流多数据流(SIMD)
  - 任务级并行
    - 线程级并行大量存在于Internet应用
    - 多核处理器及多线程处理器是目前的热点
- 虚拟化：自己麻烦点，让用户好用点
  - 应用和实现的“桥梁”
  - 计算机中的桥梁
    - 特优：操作系统对虚拟地址空间的支持(CPU中实现TLB)
    - 优：多发射在维持串行编程模型的情况下提高了速度
    - 优：多线程和虚拟机技术在单一硬件上虚拟出多个CPU
    - 良：Cache在维持一维的地址空间的情况下提高了速度
    - 一般：Cache一致性协议在分布存储的情况下提供统一编程空间