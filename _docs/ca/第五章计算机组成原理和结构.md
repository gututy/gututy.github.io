# 计算机组成原理和结构
## 冯诺依曼结构
### 基本原理
- **存储程序和指令驱动执行**
  - ①计算机由存储器、运算器、控制器、输入设备、输出设备组成，运算器和控制器合称为中央处理器(Central Processing Processor，简称CPU)。**计算机从输入设备接收程序和数据存放在存储器中；CPU运行程序处理数据；最后将结果通过输出设备输出。**
  - ②存储器时按地址访问的线性编址的一维结构，每个单元的位数固定。采用存储程序方式，即指令和数据不加区别混合存储在同一个存储器中
  - ③控制器从存储器中取出指令并根据指令要求发出控制信号控制计算机的操作。控制器中的程序计数器指明要执行的指令所在的存储单元地址。程序计数器一般按顺序递增，但可按照指令要求改变
  - ④以运算器为中心，输入输出设备与存储器之间的数据传送都经过运算器

![计算机硬件系统的组成](./第五章图/计算机硬件系统的组成.bmp)

### 冯诺依曼结构的演进
- ①以运算器为中心改进为以存储器为中心，数据流向更加合理，从而使运算器、存储器和IO设备能够并行工作
- ②由单一的集中控制改进为分散控制。早期的计算机工作速度低，运算器、存储器、控制器和IO设备可以在同一个时钟信号的控制下同步工作；现在运算器、存储器和IO设备的速度差异很大，需要异步分散控制
- ③从基于串行算法改进为适应并行算法。出现了流水线处理器、超标量处理器、向量处理器、多核处理器、对称多处理器(Symmetric Multiprocessor，简称SMP)、大规模并行处理机(Massively Parallel Processing，简称MPP)和机群系统等
- ④出现为适应特殊需要的专用计算机，如图形处理器(Graphic Processing Unit，简称GPU)、数字信号处理器(Digital Signal Processor，简称DSP)等。
### 冯诺依曼结构的优缺点
- 本质特征
  - 存储程序和指令驱动执行
  - 目前计算机没有能突破该结构特征的，都是对冯诺依曼结构的变种(如哈佛结构、并行结构等)
- 优点
  - 自动、快速执行
- 缺点：喂不饱的运算器
  - 指令驱动的顺序执行
  - CPU和存储器分开，而且越来越远
## 计算机的组成部件
### 计算机组成部分
- 计算机五大部分逻辑组成
  - 输入设备：键盘、鼠标、扫描仪……
  - 输出设备：显示器、打印机、扬声器……
  - 逻辑运算器：加、减、乘、除、与、或、非……
  - 控制器：取指、译码、跳转、访存……
  - 存储器：内存、硬盘、SSD……
- 物理上分为三大部分
  - CPU：运算器+控制器+高速缓存
  - 内存：主要由DRAM组成
  - IO设备：I和O的控制和通信是一致的
  - 三大部分之间的通信和同步对性能至关重要
#### 运算器(详见第八章)
#### 控制器(详见第九章)
#### 存储器
> 存储器存储程序和数据，又称主存储器或内存，一般用动态随机访问存储器(Dynamic Random Access Memory，简称**DRAM**)实现。CPU可以直接访问，IO设备也频繁和它交换数据。
>
> 存储器的存取速度往往满足不了CPU的快速要求，容量也满足不了应用的需要，为此将存储系统分为高速缓存(Cache)、主存储器和辅助存储器三个层次
> - Cache存放当前CPU最频繁访问的部分主存储器内容，采用比DRAM速度快但容量小的静态随机访问存储器(Static Random Access Memory，简称**SRAM**)实现。数据和指令在Cache和主存储器之间的调动由硬件自动完成。
> - 为扩大存储容量，使用磁盘、磁带、光盘等大容量存储器作为辅助存储器。计算机运行时所需的应用程序、系统软件和数据等都先存放在辅助存储器中，在运行过程中分批调入主存储器。数据和指令在主存储器和辅助存储器之间的调动由操作系统完成
>
> CPU访问存储器时面对的是一个高速(接近于Cache的速度)、大容量(接近于辅助存储器的容量)的存储器
>
> 现代计算机中还有少量只读存储器(Read Only Memory，简称ROM)用来存放引导程序和基本输入输出系统(Basic Input Output System，简称BIOS)等
>
> 计算机访问内存时采用虚拟地址，操作系统负责维护虚地址和物理地址转换的页表，集成在CPU中的存储管理部件MMU负责把虚拟地址转换为物理地址
##### 存储介质
- SRAM(易失、快、贵)        //易失指断电后数据丢失
  - Cache
- DRAM(易失、慢、便宜)
  - DDR SDRAM、Rambus DRAM
- 闪存(非易失、快、贵)
  - U盘、SSD
- 磁性存储介质(非易失、慢、便宜)
  - 硬盘、磁带
##### 存储层次
- 局部性原理
  - 时间局部性：一个数据被访问，那么短时间内可能被再次访问
  - 空间局部性：一个数据被访问，那么临近数据也可能被访问
- 访问速度(延迟)
  - 寄存器：一拍多个
  - L1：1-4拍           //指的是缓存的级数
  - L2：10-20拍
  - L3：40-60拍
  - 内存：100-200拍

![存储层次](./第五章图/存储层次.png)

##### 高速缓存(详见第九章)
##### 内存
- 冯诺依曼结构中的“存储器”
  - 采用动态随机存储器DRAM，每个单元只需要一个晶体管，通过电容充放电保存数据，需要动态刷新
  - SDRAM、DDR SDRAM、DDR2 SDRAM、DDR3 SDRAM、DDR4 SDRAM……
- 是CPU性能的决定性因素
  - 容量沿摩尔定律不断变大，但延迟降低非常缓慢
  - 早期内存通过北桥连接到CPU，现代CPU直接带内存控制器
  - CPU内设置多级Cache来降低平均延迟

![内存1](./第五章图/内存1.png)

- 内存基本单元
  - 由MOS管T和电容(存储单元)组成        //1T1C
  - 电容C存储的电位决定存储单元的逻辑值
  - 字线(Word Line)：根据地址译码，链接同一字的不同位
  - 位线(Bit Line)：读写的数据，链接不同字的同一位
  - 感应放大器(Sense Amplifier)
  
![DRAM单元读写](./第五章图/DRAM单元读写.png)

- 读写过程
  - 读：IDLE -> 行激活 -> 读数据(1次或多次突发) -> 预充电 -> IDLE
  - 写：IDLE -> 行激活 -> 写数据(1次或多次突发) -> 预充电 -> IDLE
  - 刷新：C中的电容可能会漏掉，因此DRAM需要周期刷新，刷新可通过读操作进行，一般每行几十微秒刷新一次
- 具体读写过程
  - 行激活(Active)
    - Bank和Row地址(BA0-BA2选择Bank，A0-A15选择Row)译码
  - 读写数据
    - 列地址译码(复用行地址A0-A_)，读写用
    - 读操作：位线已预充到$V_{ref}=V_{CC}/2$，字线打开T管，C引起位线微小的电位差，感应放大器读出，读出后C中的电位被破坏
    - 写操作：先把位线预充到要写的值，然后打开字线把位线的值写入C。
  - 预充
    - 关闭字/位线，行缓冲的数据写回存储阵列，位线预充到$V_{ref}=V_{CC}/2$
    - 关行(close page)：每次读写后自动预充，行缓冲不命中，延迟固定
    - 开行(open page)：地址切换时预充，地址不切换直接访问行缓存(局部性)
- 提高访存性能的方法
  - 利用行缓冲局部性
    - 利用输出端的行缓存，如果两次访问在同一行，可降低访问延迟
    - close page：打开 -> 读写 (自动关行)
    - open page：命中：读写；不命中：关行(预充) -> 打开 -> 读写
  - 利用Bank级并行性
    - DRAM芯片的多个Bank可以流水并行执行
    - 要求连续的访问针对不同的Bank
  - 内存控制器的调度
    - 内存控制器同时对几十个不同的访问进行调度
    - 调度访问次序，利用行缓存局部性和Bank级并行性
    - 支持多个Outstanding访问操作，读优先
#### 输入输出设备
> IO设备实现计算机与外部世界的信息交换
>
> 传统的IO设备有键盘、鼠标、打印机和显示器等；新型IO设备能进行语音、图像、影视的输入输出和手写体文字输入，并支持计算机之间通过网络进行通信；磁盘等辅助存储器在计算机中也当作IO设备管理
>
> 处理器通过读写IO设备控制器中的寄存器来访问和控制IO设备
>
> 高速IO设备可以在处理器安排下直接与主存储器成批交换数据，成为直接存储器访问(Directly Memory Access，简称DMA)。
>
> 处理器通过查询设备控制器状态与IO设备进行同步，也可以通过中断与IO设备进行同步
##### 硬盘
- 永久性大容量存储设备
  - 构造原理：将磁性材料覆盖在圆形碟片上，通过一个读写头(磁头)悬浮在碟片表面来感知存储的数据
  - 容量大，价格低，顺序访问
  - 访问时间ms级：先磁道，再扇区，与转速有关
  - 通过磁盘阵列提高吞吐率，比如RAID
- 与CPU可以通过PIO也可以通过DMA方式传输数据(详见本章最后一节)
  - 磁盘控制器中有缓存，在缓存命中速度高很多
##### 闪存
- 非易失性半导体存储器
  - 可以随机访问
  - 访问延迟只有磁盘的千分之一到百分之一
  - 容量比磁盘小，每GB价格高
- NOR Flash和NAND Flash
  - NOR Flash容量小，写入慢，但可靠性高，一般用作BIOS存储
  - NAND Flash容量大，存储单位随擦写次数多容易损坏，可通过地址重映射方式来分布写操作，称为磨损均衡(Wear Leveling)，平均擦写可达10万次，U盘、SD卡、SSD固态硬盘均采用NAND Flash
  - NAND Flash比NOR Flash更容易出位交换错，需要ECC算法纠正
##### GPU 
- GPU是与CPU联系最紧密的“外设”
  - NVIDIA、Imagination、ATI(AMD)、Intel、ARM
- CPU(内存)和GPU(显存)之间的数据传输
  - CPU把要显示的原始数据放在内存，有些数据通过PIO写到显存
  - GPU通过DMA把原始数据从内存搬到显存
  - CPU通过Uncache Accelerate技术把多个连续的写操作以加速写显存
  - 显存中的帧缓存(Frame Buffer)需要定时访问以刷新屏幕(如每秒60帧)，并具有最高的访问优先级
- APU把显存和内存合并
  - 减少CPU和GPU的数据搬运，但增加了内存的负担(GPU在计算时也要访问内存)
  - **这种情况下GPU是CPU的协处理器，不属于IO设备**
---
- GPU的内部结构
  - 功能：图形渲染流水线的硬件加速实现
    - 顶点读入VF(Vertex Fetch)：从内存/显存中取出顶点信息(位置/颜色等)
    - 顶点渲染VS(Vertex Shader)：对每一个顶点进行坐标变换、颜色计算
    - 图元装配PA(Primitive Assembly)：将顶点组合成图元，如点、线段、三角形等
    - 光栅化RS(Rasterization)：将矢量图形点阵化
    - 像素渲染FS(Fragment Shader)：计算每个像素的颜色(纹理采样)
    - 帧缓冲操作FOP(Frame Buffer Operation)：进行深度测试，计算最终的像素颜色
  - 实现
    - 专用硬件：VF、PA、RS、FOP
    - 可编程众核：VS、FS
## 计算机系统硬件结构发展
### CPU+GPU+北桥+南桥
- 处理器+芯片组时代
  - 在此之前是分离元件时代
- 计算机硬件结构四大组件
  - CPU、北桥、GPU、南桥
  - 内存连在北桥上
  - 北桥是系统连接的枢纽
  - 南桥链接低速IO设备

![四片结构](./第五章图/四片结构.png)

### CPU+北桥+南桥
- GPU被集成到北桥中
  - 对于图形性能要求不是特别高的场景，如桌面办公、上网本等

![三片结构](./第五章图/三片结构.png)

### CPU+弱北桥+南桥
- 内存控制器被集成到CPU中
  - 大大缓解了冯诺依曼结构带来的缓存瓶颈，平均可带来30%的性能提高
  - 降低了对系统总线的需求

![弱北桥三片结构](./第五章图/弱北桥三片结构.png)

### CPU+南桥
- GPU被集成到处理器中
  - 北桥功能进一步减弱，和南桥合并，形成处理器+南桥两片结构
  - GPU集成到处理器中减少了从内存到显存的数据传输，但显存合并到内存增加了内存压力，GPU对内存带宽要求很高，且实时性要求高
- 内存控制器集成在CPU中，GPU集成在南桥中的两片方案也是一个不错的选择
  - 独立显存有利于性能
  - CPU升级方便

![两片结构](./第五章图/两片结构.png)

### SoC单片方案
- 所有接口都集成在一个芯片上，形成片上系统(System on Chip)
  - 单片系统降低了系统设计灵活性，一般用于中低端设备和移动设备
- 主要CPU厂商中，高端CPU采用两片方案，低端CPU采用单片方案
- 片上集成的方案
  - 通过在一个封装内集成多个硅片进行互联，形成的单芯片方案

![单片](./第五章图/SoC单片.png)

## 处理器与IO间的通信
### CPU、内存和IO
- 冯诺依曼结构
  - 五部分组成：运算器、控制器、存储器、输入设备、输出设备
  - 物理上分为三大部分：CPU(运算器+控制器)、内存(DRAM)、IO(I+O)
- 三大部分关系
  - CPU/内存：CPU Load/Store访问内存，高带宽、低延迟
  - IO/内存：IO通过DMA访问内存，较高带宽、高延迟
  - CPU/IO：CPU通过PIO访问IO，低带宽、高延迟
- CPU与IO同步关系
  - 查询：CPU通过不断读取IO状态寄存器的内容获取设备控制器的状态
  - 中断：设备完成某个操作时产生中断通知CPU，把CPU从等待IO中解放出来，提高CPU的利用率，一般与DMA配合使用
### IO寄存器寻址
- IO访问与存储访问的不同
  - 存储器是存储单元阵列，存储访问通过读写指令直接完成，对某单元的读写不会影响其他单元
  - IO设备有专门的设备控制器，设备控制器向CPU提供一组IO寄存器，CPU通过读取IO寄存器获知IO控制器状态，通过写(有时候是读)IO寄存器来控制IO设备，CPU写入IO寄存器的数据会被设备管理器解释成控制IO设备的命令
- IO寄存器寻址
  - 通过独立的IO指令寻址，如X86的IN和OUT指令
  - 内存映射IO：把IO寄存器的地址映射到内存地址空间中，这些寄存器和内存存储单元被统一编址，如MIPS通过LW和SW指令的地址区分是内存访问还是IO访问
### CPU和IO设备间的同步
> CPU和IO控制器是两个不同的主体，两者**协同**完成IO访问
- 查询方式(轮询)
  - CPU通过不断读取IO状态寄存器的内容获取设备控制器的状态
  - 如打印机控制器包括状态寄存器和控制寄存器，CPU在打印一串数据时先把数据写入数据寄存器然后不断读取状态寄存器的值，当读出的“完成位”为“1”时，再把下一个数据写入数据寄存器
- 中断方式
  - 查询方式效率太低，改由设备完成某个操作时产生中断通知CPU，把CPU从等待IO中解放出来，提高CPU的利用率
  - 如CPU写入打印机的数据寄存器后转去执行别的操作，打印机打印完数据寄存器的数据后通过中断通知CPU，CPU再查询状态寄存器
### 存储器和IO设备间的通信
- 存储器和IO设备之间需要大量的通信
  - 系统启动时，需要操作系统代码和数据从硬盘搬运到内存
  - 显示输出时，需要把显示数据从内存搬运到GPU的显存
  - 冯诺依曼结构本质上是以内存为中心的结构
- 存储器与IO设备间通信有两种方式
  - PIO(Programming Input/Output)方式：CPU从IO设备/内存中把数据读到CPU内部寄存器中，再写入到内存/IO设备
  - DMA(Direct Memory Access)方式：在内存和外设之间开辟直接的数据传输通道，由DMA控制器控制数据在内存和外设之间直接、连续传输
#### PIO传输方式
- IO设备和内存之间的通信通过CPU的寄存器中转
  - CPU与IO之间的同步可以是查询方式也可以是中断方式
- 使用PIO传输方式的设备
  - 计算机中的多数设备可以通过PIO访问
  - 低速设备如键盘、鼠标只能通过PIO访问
- CPU访问IO设备都是Uncache访问
  - 提供Uncache Accelerate加速：把多个连续访问合并成一个大的
  - 对很多IO设备的性能至关重要，如CPU往GPU传数据时，部分数据通过PIO方式传输
#### DMA数据传输
- 在存储器和外设之间开辟直接的数据传送通道，数据传送由专门的硬件(DMA控制器)来控制
  - 处理器为DMA请求预先分配一段地址空间
  - 处理器设置DMA控制器参数(包括设备标识、数据传送的方向、内存中用于数据传送的源地址或目标地址、传输的字节数量等)，之后可以去干别的事
  - DMA控制器进行数据传输
  - DMA控制器向处理器发出一个中断，通知处理器数据传送的结果(成功或者出错以及错误信息)
  - 处理器完成本次DMA请求，可以开始新的DMA请求
- DMA要Cache和内存的一致性
  - DMA前CPU先刷Cache，现代处理器一般由硬件自动维护一致性
- 多数高速IO设备均采用DMA传输方式
  - 硬盘、网络、显示等设备

> PIO 与 DMA 对比
> ![PIO与DMA](./第五章图/PIO与DMA.png)


#### CPU、GPU和DC(显示控制器)间的数据传输
- 几种数据传输方式
  - PIO方式
    - CPU读写GPU中的控制寄存器
    - CPU读写DC中的控制寄存器
    - CPU读写显存
  - DMA方式
    - GPU读写内存/显存
    - DC读写内存/显存
- GPU与DC之间的DMA差异
  - DC的DMA行为比较简单
    - DC的作用是将画面进行持续显示，无需进行复杂度计算
    - DC的DMA初始化主要是将显示分辨率，帧缓冲(Frame Buffer)指针配置好，然后开始周期性的DMA数据搬运
    - CPU或GPU在这一过程中会周期性的向一个帧缓冲或多个帧缓冲(与DC的实现相关)进行填充，填充时机通常由DC的中断决定
  - GPU的DMA行为稍微复杂
    - 只有需要的时候CPU才会调用GPU进行运算
    - GPU的初始化主要是描述符列表的指针，描述符是在内存里规定好的数据结构。每个描述符中又包含指向数据区域的指针
    - CPU在需要的时候会将数据区域填好，修改相应的描述符，再通知GPU启动DMA。GPU通过描述符得到数据区域，进行相应计算

![龙芯两片方案](./第五章图/龙芯两片方案.png)

##### 显示模式
- 模式一：不使用GPU，CPU和DC共享显存
  - 共享显存
    - 不使用桥片上的显存，而是在内存中分配一个区域专供显示使用
    - 该区域称为帧缓存(Frame Buffer)
  - 数据传输方式
    - CPU读写DC中的控制寄存器，启动DMA
      - PIO操作
    - CPU将需要显示的内容写入内存帧缓存
      - CPU正常内存操作
    - DC读内存帧缓存
      - DMA操作

![龙芯模式一](./第五章图/龙芯两片方案模式一.png)

---

- 模式二：不使用GPU，CPU与DC使用独立显存
  - 独立显存
    - 使用桥片上的显存
    - 这个区域称之为帧缓存
  - 数据传输方式
    - CPU读写DC中的控制寄存器，启动传输
      - PIO操作
    - CPU将需要显示的内容从内存中读出，再写入独立显存上的帧缓存
      - PIO操作
    - DC读显存帧缓存
      - 桥片内的访存显存操作

![龙芯模式二](./第五章图/龙芯两片方案模式二.png)

---

- 模式三：CPU、GPU/DC使用共享显存
  - 数据传输方式
    - CPU读写DC中的控制寄存器，启动DMA
      - PIO操作
    - CPU在内存中分配GPU使用的空间，并将相关数据填入
    - CPU读写GPU中的控制寄存器，启动DMA
      - PIO操作
    - GPU读内存
      - DMA操作
    - GPU将计算结果写入内存帧缓存
      - DMA操作
    - DC读内存帧缓存
      - DMA操作

![龙芯模式三](./第五章图/龙芯两片方案模式三.png)

---

- 模式四：CPU、GPU/DC使用独立显存
  - 数据传输方式
    - CPU读写DC中的控制寄存器，启动DMA
      - PIO操作
    - CPU在内存中分配GPU使用的空间，并将相关数据填入
    - CPU读写GPU中的控制寄存器，启动DMA
      - PIO操作
    - GPU读内存
      - DMA操作
    - GPU将计算结果写入显存帧缓存
      - 桥片内的访存显存操作
    - DC读内存帧缓存
      - 桥片内的访存显存操作

![龙芯模式四](./第五章图/龙芯两片方案模式四.png)

---

##### 四种使用模式的比较
- 无GPU的共享显存与独立显存
  - 对CPU来说，写内存的性能比写IO的性能高得多
  - 在DC读内存(DMA)带宽能够保证的前提下共享显存性能更好
- 有GPU的共享显存和独立显存
  - 独立显存的使用能够减少两次DMA操作，有效降低内存带宽需求
- 有无GPU的比较
  - GPU对于复杂图形变换计算效率较高，尤其是处理3D图形时
  - CPU在处理简单图形时会更快，并且节省了DMA启动开销
- 实际使用中，即使有GPU也会存在一些显示数据由CPU直接写入帧缓存的情况，所以PIO性能也会对系统性能造成一定影响

### IO中断控制器
- 中断：打断当前CPU的执行进程，转去执行某特定程序
  - 中断源发出中断信号到中断控制器
  - 中断控制器产生中断请求给CPU
  - CPU响应中断并读取中断类型码
  - CPU根据中断类型执行相应的中断服务程序
  - CPU从中断服务程序返回
- 中断信号的传递
  - 中断线直传和MSI(Message Signaled Interrupt)
- Intel 8295A中断寄存器
  - 中断请求寄存器(IRR)：存放当前的中断请求
  - 中断在服务寄存器(ISR)：存放正在服务的中断请求
  - 中断屏蔽寄存器(IMR)：存放中断屏蔽位
